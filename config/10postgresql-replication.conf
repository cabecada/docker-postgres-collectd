<Plugin "postgresql">

# calculate replication lag in bytes
  <Query replication_lag>
    Statement "SELECT slot_name, \
      sent_offset - ( replay_offset - (sent_xlog - replay_xlog) * 255 * 16 ^ 6 ) \
      AS byte_lag FROM ( \
        SELECT slot_name, \
        ('x'||split_part(sent_location, '/', 1))::text::bit(32)::integer AS sent_xlog, \
        ('x'||split_part(replay_location, '/', 1))::text::bit(32)::integer AS replay_xlog, \
        ('x'||split_part(sent_location, '/', 2))::text::bit(32)::integer AS sent_offset, \
        ('x'||split_part(replay_location, '/', 2))::text::bit(32)::integer AS replay_offset \
        FROM pg_stat_replication
        INNER JOIN pg_replication_slots ON pg_stat_replication.pid=pg_replication_slots.active_pid) \
      AS s;"
    <Result>
      Type gauge
      InstancePrefix repl_lag
      InstancesFrom clot_name
      ValuesFrom byte_lag
    </Result>
    MinVersion 90100
    MaxVersion 90100
  </Query>

  <Query replication_lag>
    Statement "SELECT slot_name, \
      pg_xlog_location_diff( \
      pg_stat_replication.sent_location,\
      pg_stat_replication.replay_location) \
      AS byte_lag FROM pg_stat_replication
      INNER JOIN pg_replication_slots ON pg_stat_replication.pid=pg_replication_slots.active_pid;"
    <Result>
      Type gauge
      InstancePrefix repl_lag
      InstancesFrom slot_name
      ValuesFrom byte_lag
    </Result>
    MinVersion 90200
  </Query>

  <Query xlog_position>
    Statement "SELECT 'rate' as rate, 'absolute' as absolute, ('x' || lpad(hex, 16, '0'))::bit(64)::bigint AS xlog_int8 FROM (SELECT (split_part(xlog_location::text, '/', 1)||split_part(xlog_location::text, '/', 2)) FROM pg_current_xlog_location() as xlog_location) t(hex);"
    <Result>
      Type counter
      InstancePrefix xlog_pos
      InstancesFrom rate
      ValuesFrom xlog_int8
    </Result>
    <Result>
      Type gauge
      InstancePrefix xlog_pos
      InstancesFrom absolute
      ValuesFrom xlog_int8
    </Result>
  </Query>

  <Database template1>
    Host "lb.postgres-cluster-puppetdb"
    Port "5432"
    User "postgres"
    Query replication_lag
    Query xlog_position
  </Database>

</Plugin>
